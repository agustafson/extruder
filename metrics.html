<html><head><title>extruder: Metrics</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Chris Jansen" /><meta name="description" content="Populate Scala case classes from any data source" /><meta name="og:image" content="/extruder/img/poster.png" /><meta name="og:title" content="extruder: Metrics" /><meta name="og:site_name" content="extruder" /><meta name="og:url" content="https://janstenpickle.github.io/extruder/" /><meta name="og:type" content="website" /><meta name="og:description" content="Populate Scala case classes from any data source" /><link rel="icon" type="image/png" href="/extruder/img/favicon.png" /><meta name="twitter:title" content="extruder: Metrics" /><meta name="twitter:image" content="https://janstenpickle.github.io/extruder/img/poster.png" /><meta name="twitter:description" content="Populate Scala case classes from any data source" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/extruder/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="32x32" href="/extruder/img/favicon32x32.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/extruder/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/extruder/css/style.css" /><link rel="stylesheet" href="/extruder/css/palette.css" /><link rel="stylesheet" href="/extruder/css/codemirror.css" /><link rel="stylesheet" href="/extruder/css/override.css" /><link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/extruder/" class="brand"><div class="brand-wrapper"><span>extruder</span></div></a></li> <li><a href="/extruder/concepts.html" class="">Concepts</a></li> <li><a href="/extruder/usage.html" class="">Usage</a></li> <li><a href="/extruder/decode_encode.html" class="">Decoding and encoding</a></li> <li><a href="/extruder/combining.html" class="">Combining Data Sources</a></li> <li><a href="/extruder/extending.html" class="">Extending a Data Source</a></li> <li><a href="/extruder/typeclasses.html" class="">Type Classes</a></li> <li><a href="/extruder/datatypes.html" class="">Data Types</a></li> <li><a href="/extruder/metrics.html" class="">Extruder Metrics</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/janstenpickle/extruder"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/janstenpickle/extruder"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('extruder Populate Scala case classes from any data source');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('extruder Populate Scala case classes from any data source');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="janstenpickle" data-github-repo="extruder"><div class="content-wrapper"><section><ul id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#metric-encoding" id="markdown-toc-metric-encoding">Metric Encoding</a>    <ul>
      <li><a href="#name-spaced-metrics" id="markdown-toc-name-spaced-metrics">Name-spaced Metrics</a></li>
      <li><a href="#dimensional-metrics" id="markdown-toc-dimensional-metrics">Dimensional metrics</a></li>
      <li><a href="#lack-of-depth" id="markdown-toc-lack-of-depth">Lack of depth</a></li>
      <li><a href="#additional-dimensions" id="markdown-toc-additional-dimensions">Additional dimensions</a>        <ul>
          <li><a href="#encoding-and-compilation" id="markdown-toc-encoding-and-compilation">Encoding and compilation</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#metric-types" id="markdown-toc-metric-types">Metric Types</a></li>
  <li><a href="#label-values" id="markdown-toc-label-values">Label Values</a></li>
  <li><a href="#provided-encoders" id="markdown-toc-provided-encoders">Provided Encoders</a>    <ul>
      <li><a href="#dropwizard" id="markdown-toc-dropwizard">Dropwizard</a></li>
      <li><a href="#prometheus" id="markdown-toc-prometheus">Prometheus</a></li>
      <li><a href="#spectator" id="markdown-toc-spectator">Spectator</a></li>
    </ul>
  </li>
</ul>

<h1 id="overview">Overview</h1>
<p>The extruder metrics modules provide support for encoding case classes as name-spaced or dimensional metrics.</p>

<h1 id="metric-encoding">Metric Encoding</h1>

<p>Exturder supports two types of metric encoding schemes, name-spaced and dimensional. Both are described below:</p>

<h2 id="name-spaced-metrics">Name-spaced Metrics</h2>
<p>Name-spaced metrics are most commonly associated with <a href="https://graphiteapp.org/">Graphite</a>, where they are simple key values arranged in a hierarchy of common dot-seprated key elements.</p>

<p>Metrics are encoded using the path to the value in the case class structure e.g.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Test1</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Test2</span><span class="o">(</span><span class="n">metrics</span><span class="k">:</span> <span class="kt">Test1</span><span class="o">)</span>
</code></pre></div></div>
<p>Will be encoded as <code class="highlighter-rouge">test2.metrics.test1.value = 1000</code>.</p>

<h2 id="dimensional-metrics">Dimensional metrics</h2>
<p>Dimensional metrics are most commonly associated with <a href="https://prometheus.io/">Prometheus</a> where a metric has multiple labels which then may be queried in aggregate with other metrics which share the same dimensions.</p>

<p>Metrics in a case class can be encoded as follows, providing there is enough depth in the case class structure to be able to create dimensions:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">StatusCode</span><span class="o">(</span><span class="n">`200`</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2043</span><span class="o">,</span> <span class="n">`500`</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">other</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">653</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">RequestCount</span><span class="o">(</span><span class="n">httpRequests</span><span class="k">:</span> <span class="kt">StatusCode</span><span class="o">)</span>
</code></pre></div></div>

<p>Will be encoded as:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{name=http_requests,status_code=200} = 2043
{name=http_requests,status_code=500} = 3
{name=http_requests,status_code=other} = 653
</code></pre></div></div>
<p>This allows you to aggregate all <code class="highlighter-rouge">http_requests</code> values by not including the <code class="highlighter-rouge">status_code</code> dimension in a query.</p>

<p>Alternatively if there is not enough depth in the case class structure then names will be encoded as the parameter names of the case class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">HttpResponses</span><span class="o">(</span><span class="n">`200Responses`</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2043</span><span class="o">,</span> <span class="n">`500Responses`</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">otherResponses</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">653</span><span class="o">)</span>
</code></pre></div></div>

<p>Will be encoded as:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{name=200_responses,status_code=200} = 2043
{name=500_responses,status_code=500} = 3
{name=other_responses,status_code=other} = 653
</code></pre></div></div>

<p>If you donâ€™t know the possible label values ahead of time it is possible to encode a map of string to number which represents each dimension value and its corresponding reading:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">HttpRequests</span><span class="o">(</span><span class="n">statusCode</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">"200"</span> <span class="o">-&gt;</span> <span class="mi">2043</span><span class="o">,</span> <span class="s">"500"</span> <span class="o">-&gt;</span> <span class="mi">3</span><span class="o">,</span> <span class="s">"401"</span> <span class="o">-&gt;</span> <span class="mi">7643</span><span class="o">,</span> <span class="s">"other"</span> <span class="o">-&gt;</span> <span class="mi">12</span><span class="o">))</span>
</code></pre></div></div>

<p>Will be encoded as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{name=http_requests,status_code=200} = 2043
{name=http_requests,status_code=500} = 3
{name=http_requests,status_code=400} = 7643
{name=http_requests,status_code=other} = 12
</code></pre></div></div>

<h2 id="lack-of-depth">Lack of depth</h2>

<p>If your case class heirarchy is not deep enough, then extruder will encode the case classâ€™s field names as metrics. For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">StatusCode</span><span class="o">(</span><span class="n">`200`</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2043</span><span class="o">,</span> <span class="n">`500`</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">other</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">653</span><span class="o">)</span>
</code></pre></div></div>

<p>Will be encoded as:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{name=200} = 2043
{name=500} = 3
{name=other} = 653
</code></pre></div></div>

<h2 id="additional-dimensions">Additional dimensions</h2>

<p>When instantiating an implementation of a dimensional metric encoder you may provide optional additional dimensions as a string map (<code class="highlighter-rouge">Map[String, String]</code>). This allows you to specify extra metadata such as hostname or job instance to every metric recorded.</p>

<h3 id="encoding-and-compilation">Encoding and compilation</h3>

<p>Note that dimensional metric encoders will fail to compile case classes which cannot be properly represented as dimensional metrics, i.e. any case class whose fields would be encoded as separate labels would not compile if those fields are not all the same type.</p>

<h1 id="metric-types">Metric Types</h1>

<p>In order to encode a type of metric extruder includes a trait called <code class="highlighter-rouge">MetricValue</code>. Provided implementations include <code class="highlighter-rouge">Counter</code>, <code class="highlighter-rouge">Gauge</code> and <code class="highlighter-rouge">Timer</code>, each being a <a href="https://docs.scala-lang.org/overviews/core/value-classes.html">value class</a>. A case class which uses these allows for fine grained control over the type of metric for each value.</p>

<p>To encode multiple dimensions in a <code class="highlighter-rouge">Map</code>, as covered above, the type <code class="highlighter-rouge">MetricValues</code> is provided, which is a <a href="https://docs.scala-lang.org/overviews/core/value-classes.html">value class</a> class wrapper around <code class="highlighter-rouge">Map[String, MetricValue[V]]</code> where <code class="highlighter-rouge">V</code> has an implicit <code class="highlighter-rouge">Numeric</code> instance. An implicit monoid instance is also providied for this type.</p>

<p>For example it is possible to</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">extruder.metrics.data.CounterValue</span>
<span class="k">import</span> <span class="nn">extruder.metrics.conversions.counter._</span> <span class="c1">//implicitly converts numbers to CounterValue
</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">StatusCode</span><span class="o">(</span><span class="n">`200`</span><span class="k">:</span> <span class="kt">CounterValue</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="mi">2043</span><span class="o">,</span> <span class="n">`500`</span><span class="k">:</span> <span class="kt">CounterValue</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">other</span><span class="k">:</span> <span class="kt">CounterValue</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="mi">653</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">RequestCount</span><span class="o">(</span><span class="n">httpRequests</span><span class="k">:</span> <span class="kt">StatusCode</span><span class="o">)</span>
</code></pre></div></div>

<p>If you donâ€™t wish to use <code class="highlighter-rouge">MetricValue</code> or <code class="highlighter-rouge">MetricValues</code> in your case classes, encoding will still work (as seen above), however the values will be encoded as the default metric type for the encoder.</p>

<h1 id="label-values">Label Values</h1>

<p>Any type which cannot be encoded as a numeric value can be encoded as a label where the value of the field will be included in the name of the metric and the metric value set to <code class="highlighter-rouge">1</code>. For example, consider the following case class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Stats</span><span class="o">(</span><span class="n">status</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"OK"</span><span class="o">)</span>
</code></pre></div></div>

<p>Will be encoded as below in name-spaced metrics:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stats.status.OK = 1
</code></pre></div></div>
<p>Or in dimensional metrics:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{status=OK} = 1
</code></pre></div></div>
<h1 id="provided-encoders">Provided Encoders</h1>

<p>Extruder currently provides three types of encoders, although anyone is welcome to add more:</p>

<h2 id="dropwizard">Dropwizard</h2>

<p>The <a href="http://metrics.dropwizard.io">Dropwizard</a> package provides both name-spaced and dimensional metric encoders which records values in a Dropwizard metrics registry.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resolvers</span> <span class="o">+=</span> <span class="nc">Resolver</span><span class="o">.</span><span class="n">bintrayRepo</span><span class="o">(</span><span class="s">"janstenpickle"</span><span class="o">,</span> <span class="s">"maven"</span><span class="o">)</span>
<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"io.extruder"</span> <span class="o">%%</span> <span class="s">"extruder-metrics-dropwizard"</span> <span class="o">%</span> <span class="s">"0.10.0"</span>
</code></pre></div></div>

<h2 id="prometheus">Prometheus</h2>

<p>The <a href="https://prometheus.io/">Prometheus</a> package provides two dimensional metric encoders, one which records values in a Prometheus metrics registry and one which sends metrics to a <a href="https://github.com/prometheus/pushgateway">Push Gateway</a>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resolvers</span> <span class="o">+=</span> <span class="nc">Resolver</span><span class="o">.</span><span class="n">bintrayRepo</span><span class="o">(</span><span class="s">"janstenpickle"</span><span class="o">,</span> <span class="s">"maven"</span><span class="o">)</span>
<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"io.extruder"</span> <span class="o">%%</span> <span class="s">"extruder-metrics-prometheus"</span> <span class="o">%</span> <span class="s">"0.10.0"</span>
</code></pre></div></div>

<h2 id="spectator">Spectator</h2>

<p>The <a href="https://github.com/Netflix/spectator">Spectator</a> package provides a dimensional metric encode which records in a Spectator metrics registry.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"io.extruder"</span> <span class="o">%%</span> <span class="s">"extruder-metrics-spectator"</span> <span class="o">%</span> <span class="s">"0.10.0"</span>
</code></pre></div></div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/extruder/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script><script src="/extruder/js/main.js"></script></body></html>